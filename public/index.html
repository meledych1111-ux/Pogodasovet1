<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–ï–¢–†–ò–° PRO ‚Ä¢ –ü–∏—Ç–æ–º—Ü—ã</title>
    <style>
        /* ==================== –¢–í–û–ò –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò ==================== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation; 
        }
        
        html, body { 
            height: 100%; width: 100%; overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a2a 0%, #1a1a3a 100%);
            color: #ffffff;
        }
        
        body { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 8px;
        }
        
        .game-container {
            width: 100%;
            max-width: 480px;
            height: 95vh;
            max-height: 820px;
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background: linear-gradient(145deg, #0f1430, #1a1f40);
            border: 2px solid #4455cc;
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 15px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            background: inherit;
        }
        
        .screen.active {
            opacity: 1;
            pointer-events: all;
        }
        
        /* ==================== –ó–ê–ì–û–õ–û–í–û–ö ==================== */
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px 10px;
            flex-shrink: 0;
        }
        
        .game-title {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(90deg, #9d7aff, #6a5bff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(106, 91, 255, 0.5);
            margin-bottom: 5px;
            line-height: 1.2;
        }
        
        .subtitle {
            color: #b5aaff;
            font-size: 0.85rem;
        }
        
        /* ==================== –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ ==================== */
        .menu-buttons {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px 0;
            overflow-y: auto;
        }
        
        .menu-btn {
            background: linear-gradient(145deg, rgba(68, 85, 204, 0.3), rgba(51, 68, 170, 0.2));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 55px;
            flex-shrink: 0;
            border: 1px solid rgba(68, 85, 204, 0.3);
        }
        
        .menu-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .menu-btn.new-game { 
            background: linear-gradient(145deg, rgba(102, 204, 153, 0.3), rgba(77, 179, 128, 0.2));
            border-color: rgba(102, 204, 153, 0.4);
        }
        .menu-btn.stats { 
            background: linear-gradient(145deg, rgba(106, 91, 255, 0.3), rgba(86, 71, 235, 0.2));
            border-color: rgba(106, 91, 255, 0.4);
        }
        .menu-btn.leaderboard { 
            background: linear-gradient(145deg, rgba(255, 102, 204, 0.3), rgba(235, 82, 182, 0.2));
            border-color: rgba(255, 102, 204, 0.4);
        }
        .menu-btn.settings { 
            background: linear-gradient(145deg, rgba(102, 204, 204, 0.3), rgba(77, 179, 179, 0.2));
            border-color: rgba(102, 204, 204, 0.4);
        }
        
        .footer {
            padding: 12px 10px;
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: auto;
            flex-shrink: 0;
        }
        
        /* ==================== –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù - –ü–û–õ–ï –ü–†–ò–ü–û–î–ù–Ø–¢–û ==================== */
        #game-screen {
            display: flex;
            flex-direction: column;
            padding: 0px 10px 5px 10px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background: rgba(20, 30, 80, 0.7);
            border-radius: 30px;
            margin-bottom: 5px;
            flex-shrink: 0;
            border: 2px solid #4455cc;
            min-height: 48px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 6px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: 80px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 500;
        }
        
        .back-btn:before {
            content: "‚Üê";
            font-size: 1.1rem;
        }
        
        .game-info {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
        }
        
        .info-box {
            background: rgba(10, 20, 60, 0.8);
            padding: 4px 14px;
            border-radius: 30px;
            border: 1px solid rgba(68, 85, 204, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 36px;
        }
        
        .info-label {
            display: none;
        }
        
        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #66ffaa;
            text-shadow: 0 0 5px #00cc88;
        }
        
        .game-info .info-box:not(:last-child) {
            position: relative;
            margin-right: 14px;
        }
        
        .game-info .info-box:not(:last-child)::after {
            content: "‚Ä¢";
            position: absolute;
            right: -14px;
            color: #6a5bff;
            font-size: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .pet-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 182, 193, 0.2);
            border-radius: 30px;
            padding: 4px 16px;
            border: 2px solid rgba(255, 182, 193, 0.4);
            font-size: 1rem;
            margin-left: 8px;
            min-height: 38px;
            white-space: nowrap;
        }
        
        .pet-emoji {
            font-size: 1.3rem;
        }
        
        .pet-food-emoji {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px gold);
        }
        
        .pet-food-count {
            background: rgba(255, 215, 0, 0.25);
            padding: 2px 10px;
            border-radius: 30px;
            color: #ffd700;
            font-size: 0.95rem;
            font-weight: bold;
        }
        
        /* ==================== –ò–ì–†–û–í–û–ï –ü–û–õ–ï - –¢–í–û–Ø –°–ï–¢–ö–ê ==================== */
        .game-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            padding: 0;
            margin: 0;
        }
        
        #tetris-canvas {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 3px solid rgba(68, 85, 204, 0.7);
            box-shadow: 0 0 20px rgba(68, 85, 204, 0.3);
            width: 100%;
            height: auto;
            max-height: 100%;
        }
        
        /* ==================== –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ - –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô –û–¢–°–¢–£–ü ==================== */
        .game-controls-panel {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 3px;
            flex-shrink: 0;
        }
        
        .game-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 8px;
            background: rgba(20, 30, 80, 0.5);
            border-radius: 16px;
            border: 1px solid rgba(68, 85, 204, 0.4);
        }
        
        .game-btn {
            background: linear-gradient(145deg, rgba(68, 85, 204, 0.4), rgba(51, 68, 170, 0.3));
            border: 1px solid rgba(68, 85, 204, 0.5);
            border-radius: 12px;
            padding: 12px 5px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 48px;
            font-weight: 600;
        }
        
        .game-btn:active {
            transform: scale(0.96);
        }
        
        .game-btn.save-btn {
            background: linear-gradient(145deg, rgba(102, 204, 153, 0.5), rgba(77, 179, 128, 0.4));
            border-color: rgba(102, 204, 153, 0.6);
        }
        
        .game-btn.continue-btn {
            background: linear-gradient(145deg, rgba(255, 193, 7, 0.5), rgba(255, 152, 0, 0.4));
            border-color: rgba(255, 193, 7, 0.6);
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 10px;
            background: rgba(20, 30, 80, 0.5);
            border-radius: 20px;
            border: 1px solid rgba(68, 85, 204, 0.4);
        }
        
        .control-btn {
            background: linear-gradient(145deg, rgba(68, 85, 204, 0.4), rgba(51, 68, 170, 0.3));
            border: 1px solid rgba(68, 85, 204, 0.5);
            border-radius: 16px;
            padding: 14px 5px;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.1s;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        /* ==================== –¢–í–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==================== */
        .stats-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(20, 30, 80, 0.3);
            border-radius: 16px;
            margin: 10px 0;
            border: 1px solid rgba(68, 85, 204, 0.3);
        }
        
        .stat-card {
            background: rgba(30, 40, 100, 0.6);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            border-left: 5px solid #6a5bff;
            border: 1px solid rgba(106, 91, 255, 0.4);
            backdrop-filter: blur(4px);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 1.1rem;
        }
        
        .stat-label {
            color: #aaccff;
        }
        
        .stat-value {
            font-weight: bold;
            color: #66ffaa;
            font-size: 1.2rem;
        }
        
        /* ==================== –ü–ò–¢–û–ú–¶–´ –í –°–¢–ê–¢–ò–°–¢–ò–ö–ï ==================== */
        .pets-stats-block {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 182, 193, 0.1);
            border-radius: 16px;
            border: 1px solid rgba(255, 182, 193, 0.3);
        }
        
        .pet-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 40px;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        /* ==================== –õ–ò–î–ï–†–ë–û–†–î ==================== */
        .leaderboard-list {
            flex: 1;
            overflow-y: auto;
            margin: 10px 0;
            padding: 5px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(30, 40, 100, 0.6);
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid rgba(68, 85, 204, 0.3);
            border-left: 6px solid #ffcc66;
        }
        
        .rank {
            font-size: 1.5rem;
            font-weight: bold;
            width: 55px;
            text-align: center;
            color: #ffcc66;
        }
        
        .player-info {
            flex: 1;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .player-score {
            color: #66ffaa;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .pets-collection {
            background: rgba(0,0,0,0.3);
            border-radius: 40px;
            padding: 8px 16px;
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255,215,0,0.3);
        }
        
        .pets-count-badge {
            background: #ffd966;
            color: #1a1e3a;
            font-weight: bold;
            padding: 4px 14px;
            border-radius: 30px;
            font-size: 0.9rem;
        }
        
        /* ==================== –ê–ù–ò–ú–ê–¶–ò–ò ==================== */
        .food-particle {
            position: fixed;
            pointer-events: none;
            font-size: 2.2rem;
            animation: flyFood 1.2s ease-out forwards;
            z-index: 10000;
            text-shadow: 0 0 20px gold, 0 0 40px orange;
        }
        
        @keyframes flyFood {
            0% { opacity: 0; transform: scale(0.3) translateY(0) rotate(0deg); }
            20% { opacity: 1; transform: scale(1.3) translateY(-25px) rotate(20deg); }
            80% { opacity: 1; transform: scale(1.1) translateY(-90px) rotate(-15deg); }
            100% { opacity: 0; transform: scale(0.8) translateY(-140px) rotate(30deg); }
        }
        
        .pet-unlock {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            border-left: 8px solid;
            border-radius: 30px;
            padding: 16px 28px;
            display: flex;
            align-items: center;
            gap: 18px;
            font-size: 1.1rem;
            font-weight: bold;
            z-index: 10001;
            animation: slideIn 0.4s, fadeOut 0.4s 2.6s forwards;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideIn {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(20px); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(42, 153, 68, 0.95);
            color: white;
            padding: 14px 28px;
            border-radius: 40px;
            z-index: 20000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 1rem;
            font-weight: 600;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .notification.show {
            opacity: 1;
        }
        
        @media (max-height: 700px) {
            .game-header { padding: 4px 10px; min-height: 44px; }
            .control-btn { padding: 10px 5px; font-size: 1.6rem; min-height: 52px; }
            .game-btn { padding: 10px 5px; min-height: 44px; }
            .game-area { min-height: 360px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
        <div class="screen active" id="menu-screen">
            <div class="header">
                <h1 class="game-title">–¢–ï–¢–†–ò–° PRO</h1>
                <p class="subtitle">Telegram Mini App ‚Ä¢ –ö–æ–ª–ª–µ–∫—Ü–∏—è –ø–∏—Ç–æ–º—Ü–µ–≤</p>
            </div>
            
            <div class="menu-buttons">
                <button class="menu-btn new-game" onclick="startGame()">
                    <span>üéÆ</span> –ù–û–í–ê–Ø –ò–ì–†–ê
                </button>
                <button class="menu-btn stats" onclick="showStats()">
                    <span>üìä</span> –°–¢–ê–¢–ò–°–¢–ò–ö–ê
                </button>
                <button class="menu-btn leaderboard" onclick="showLeaderboard()">
                    <span>üèÜ</span> –õ–ò–î–ï–†–ë–û–†–î
                </button>
                <button class="menu-btn settings" onclick="showSettings()">
                    <span>‚öôÔ∏è</span> –ù–ê–°–¢–†–û–ô–ö–ò
                </button>
            </div>
            
            <div class="footer">
                <p style="color: #aaccff;">Neon PostgreSQL ‚Ä¢ –ü–∏—Ç–æ–º—Ü—ã –≤ localStorage</p>
            </div>
        </div>
        
        <!-- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù -->
        <div class="screen" id="game-screen">
            <div class="game-header">
                <div>
                    <button class="back-btn" onclick="showMenu()">
                        <span>–ú–ï–ù–Æ</span>
                    </button>
                </div>
                <div class="game-info" id="game-info-container">
                    <div class="info-box">
                        <div class="info-value" id="level-display">1</div>
                    </div>
                    <div class="info-box">
                        <div class="info-value" id="score-display">0</div>
                    </div>
                    <div class="info-box">
                        <div class="info-value" id="lines-display">0</div>
                    </div>
                </div>
            </div>
            
            <div class="game-area">
                <canvas id="tetris-canvas" width="240" height="480"></canvas>
            </div>
            
            <div class="game-controls-panel">
                <div class="game-buttons">
                    <button class="game-btn pause-btn" onclick="togglePause()">‚è∏ –ü–ê–£–ó–ê</button>
                    <button class="game-btn" onclick="restartGame()">üîÑ –ó–ê–ù–û–í–û</button>
                    <button class="game-btn save-btn" id="saveContinueBtn" onclick="saveGameScore()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
                </div>
                
                <div class="controls">
                    <button class="control-btn" onclick="moveLeft()">‚Üê</button>
                    <button class="control-btn" onclick="hardDrop()">‚Üì</button>
                    <button class="control-btn" onclick="rotatePiece()">‚Üª</button>
                    <button class="control-btn" onclick="moveRight()">‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê - –¢–í–û–Ø –ü–û–õ–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
        <div class="screen" id="stats-screen">
            <div class="header">
                <h1 class="game-title">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</h1>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3 style="color: #6a5bff; margin-bottom: 15px;">üìà –í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê</h3>
                    <div id="user-stats">
                        <!-- –¢–í–û–ò –î–ê–ù–ù–´–ï –ò–ó NEON -->
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <button class="back-btn" onclick="showMenu()">‚Üê –ù–ê–ó–ê–î</button>
            </div>
        </div>
        
        <!-- –õ–ò–î–ï–†–ë–û–†–î -->
        <div class="screen" id="leaderboard-screen">
            <div class="header">
                <h1 class="game-title">üèÜ –õ–ò–î–ï–†–ë–û–†–î</h1>
                <p class="subtitle">–¢–æ–ø-10 –∏–≥—Ä–æ–∫–æ–≤</p>
            </div>
            
            <div class="leaderboard-list" id="leaderboard-list"></div>
            
            <div class="footer">
                <button class="back-btn" onclick="showMenu()">‚Üê –ù–ê–ó–ê–î</button>
            </div>
        </div>
        
        <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div class="screen" id="settings-screen">
            <div class="header">
                <h1 class="game-title">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</h1>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3 style="color: #6a5bff; margin-bottom: 15px;">üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" id="keyboard-controls" checked style="margin-right: 12px; width: 18px; height: 18px;">
                            <span style="font-size: 1.1rem;">–ö–ª–∞–≤–∏—à–∏ ‚Üê ‚Üí ‚Üë ‚Üì</span>
                        </label>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3 style="color: #6a5bff; margin-bottom: 15px;">üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                    <div id="db-status" style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 15px;">
                        –°—Ç–∞—Ç—É—Å: <span id="db-status-text" style="color: #66ffaa;">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                    </div>
                    <button class="back-btn" style="width: 100%;" onclick="testDatabase()">üîÑ –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
                </div>
            </div>
            
            <div class="footer">
                <button class="back-btn" onclick="showMenu()">‚Üê –ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // ==================== –¢–ï–õ–ï–ì–†–ê–ú ID ====================
        let telegramUserId = 'guest_' + Math.floor(Math.random() * 10000);
        let telegramUsername = 'Player';
        
        (function() {
            try {
                if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
                    telegramUserId = String(window.Telegram.WebApp.initDataUnsafe.user.id);
                    telegramUsername = window.Telegram.WebApp.initDataUnsafe.user.username || 
                                      window.Telegram.WebApp.initDataUnsafe.user.first_name || 'Player';
                }
            } catch(e) {}
            window.telegramUserId = telegramUserId;
            console.log('üë§ Telegram ID:', telegramUserId);
        })();

        // ==================== –ö–û–ù–°–¢–ê–ù–¢–´ ====================
        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 24;
        const COLORS = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
            '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'
        ];
        const SHAPES = [
            [[1,1,1,1]],
            [[1,1],[1,1]],
            [[0,1,0],[1,1,1]],
            [[1,1,0],[0,1,1]],
            [[0,1,1],[1,1,0]],
            [[1,0,0],[1,1,1]],
            [[0,0,1],[1,1,1]]
        ];

        // ==================== –£–†–û–í–ù–ò (–ö–ê–ñ–î–´–ï +1000 –ü–û–°–õ–ï 1500) ====================
        const SPEED_TABLE = {
            1: 800, 2: 750, 3: 700, 4: 650, 5: 600,
            6: 550, 7: 500, 8: 450, 9: 400, 10: 350,
            11: 300, 12: 280, 13: 260, 14: 240, 15: 220
        };

        // ==================== –í–°–ï –ü–ò–¢–û–ú–¶–´ (29) ====================
        const PETS = [
            { id: 'cat', name: '–ö–æ—Ç–µ–Ω–æ–∫', emoji: 'üê±', color: '#FFB6C1', score: 1000, food: 'üç£' },
            { id: 'dog', name: '–©–µ–Ω–æ–∫', emoji: 'üêï', color: '#D2B48C', score: 1500, food: 'ü¶¥' },
            { id: 'rabbit', name: '–ó–∞–π–∫–∞', emoji: 'üêá', color: '#F0F0F0', score: 2000, food: 'ü•ï' },
            { id: 'fox', name: '–õ–∏—Å–µ–Ω–æ–∫', emoji: 'ü¶ä', color: '#FF8C42', score: 2500, food: 'üçá' },
            { id: 'panda', name: '–ü–∞–Ω–¥–∞', emoji: 'üêº', color: '#2E2E2E', score: 3000, food: 'üéã' },
            { id: 'owl', name: '–°–æ–≤–µ–Ω–æ–∫', emoji: 'ü¶â', color: '#8B4513', score: 3500, food: 'üìö' },
            { id: 'penguin', name: '–ü–∏–Ω–≥–≤–∏–Ω', emoji: 'üêß', color: '#1E3F66', score: 4000, food: 'üêü' },
            { id: 'koala', name: '–ö–æ–∞–ª–∞', emoji: 'üê®', color: '#A9A9A9', score: 4500, food: 'üåø' },
            { id: 'tiger', name: '–¢–∏–≥—Ä–µ–Ω–æ–∫', emoji: 'üêØ', color: '#FFA500', score: 5000, food: 'ü•©' },
            { id: 'lion', name: '–õ—å–≤–µ–Ω–æ–∫', emoji: 'ü¶Å', color: '#FFD700', score: 5500, food: 'üëë' },
            { id: 'giraffe', name: '–ñ–∏—Ä–∞—Ñ–∏–∫', emoji: 'ü¶í', color: '#FFCC33', score: 6000, food: 'üåø' },
            { id: 'zebra', name: '–ó–µ–±—Ä–∞', emoji: 'ü¶ì', color: '#000000', score: 6500, food: 'üé®' },
            { id: 'elephant', name: '–°–ª–æ–Ω–µ–Ω–æ–∫', emoji: 'üêò', color: '#808080', score: 7000, food: 'üíß' },
            { id: 'rhino', name: '–ù–æ—Å–æ—Ä–æ–≥', emoji: 'ü¶è', color: '#696969', score: 7500, food: 'üõ°Ô∏è' },
            { id: 'hippo', name: '–ë–µ–≥–µ–º–æ—Ç', emoji: 'ü¶õ', color: '#8A6E4B', score: 8000, food: 'üí¶' },
            { id: 'monkey', name: '–û–±–µ–∑—å—è–Ω–∫–∞', emoji: 'üêí', color: '#8B4513', score: 8500, food: 'üçå' },
            { id: 'sloth', name: '–õ–µ–Ω–∏–≤–µ—Ü', emoji: 'ü¶•', color: '#6B8E23', score: 9000, food: '‚è∞' },
            { id: 'hedgehog', name: '–ï–∂–∏–∫', emoji: 'ü¶î', color: '#8B4513', score: 9500, food: 'üçé' },
            { id: 'squirrel', name: '–ë–µ–ª–æ—á–∫–∞', emoji: 'üêøÔ∏è', color: '#CD853F', score: 10000, food: 'üå∞' },
            { id: 'deer', name: '–û–ª–µ–Ω–µ–Ω–æ–∫', emoji: 'ü¶å', color: '#8B5A2B', score: 10500, food: 'üåø' },
            { id: 'unicorn', name: '–ï–¥–∏–Ω–æ—Ä–æ–≥', emoji: 'ü¶Ñ', color: '#FF69B4', score: 11000, food: '‚ú®' },
            { id: 'dragon', name: '–î—Ä–∞–∫–æ–Ω—á–∏–∫', emoji: 'üêâ', color: '#DC143C', score: 11500, food: 'üî•' },
            { id: 'phoenix', name: '–§–µ–Ω–∏–∫—Å', emoji: 'ü¶Ö', color: '#FF4500', score: 12000, food: 'üåÖ' },
            { id: 'whale', name: '–ö–∏—Ç', emoji: 'üêã', color: '#4169E1', score: 12500, food: 'üåä' },
            { id: 'dolphin', name: '–î–µ–ª—å—Ñ–∏–Ω', emoji: 'üê¨', color: '#4682B4', score: 13000, food: 'üèä' },
            { id: 'crocodile', name: '–ö—Ä–æ–∫–æ–¥–∏–ª', emoji: 'üêä', color: '#2E8B57', score: 13500, food: 'üêü' },
            { id: 'kangaroo', name: '–ö–µ–Ω–≥—É—Ä—É', emoji: 'ü¶ò', color: '#CD853F', score: 14000, food: 'ü¶ò' },
            { id: 'camel', name: '–í–µ—Ä–±–ª—é–¥', emoji: 'üê´', color: '#C19A6B', score: 14500, food: 'üåµ' },
            { id: 'peacock', name: '–ü–∞–≤–ª–∏–Ω', emoji: 'ü¶ö', color: '#4B0082', score: 15000, food: 'üåà' }
        ];

        // ==================== –ò–ì–†–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let board = [];
        let currentPiece = null;
        let currentX = 0;
        let currentY = 0;
        let score = 0;
        let level = 1;
        let lines = 0;
        let totalLines = 0;
        let gameActive = false;
        let gamePaused = false;
        let gameOver = false;
        let dropCounter = 0;
        let dropInterval = 800;
        let lastTime = 0;
        let animationId = null;
        let currentDifficulty = 'medium';
        let clearedLinesAnimation = [];
        let pieceQueue = [];
        
        // –ü–∏—Ç–æ–º—Ü—ã
        let userPets = [];
        let activePet = null;
        
        // DOM
        const canvas = document.getElementById('tetris-canvas');
        const ctx = canvas.getContext('2d');
        const screens = {
            menu: document.getElementById('menu-screen'),
            game: document.getElementById('game-screen'),
            stats: document.getElementById('stats-screen'),
            leaderboard: document.getElementById('leaderboard-screen'),
            settings: document.getElementById('settings-screen')
        };

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –ü–ò–¢–û–ú–¶–ï–í ====================
        function loadPets() {
            try {
                const saved = localStorage.getItem(`tetris_pets_${telegramUserId}`);
                if (saved) {
                    const data = JSON.parse(saved);
                    userPets = data.pets || [];
                    userPets.forEach(sp => {
                        const pet = PETS.find(p => p.id === sp.id);
                        if (pet) pet.rewards = sp.rewards || 0;
                    });
                    if (userPets.length) {
                        const last = userPets[userPets.length - 1];
                        activePet = PETS.find(p => p.id === last.id);
                        if (activePet) activePet.rewards = last.rewards || 0;
                    }
                }
            } catch(e) {
                userPets = [];
            }
        }

        function savePets() {
            localStorage.setItem(`tetris_pets_${telegramUserId}`, JSON.stringify({
                pets: userPets.map(p => ({
                    id: p.id,
                    rewards: PETS.find(pet => pet.id === p.id)?.rewards || 0
                }))
            }));
        }

        // ==================== –ü–ê–ù–ï–õ–¨–ö–ê –ü–ò–¢–û–ú–¶–ê ====================
        function createPetPanel() {
            if (document.getElementById('pet-header-panel')) return;
            const container = document.getElementById('game-info-container');
            const panel = document.createElement('div');
            panel.id = 'pet-header-panel';
            panel.className = 'pet-badge';
            panel.style.display = 'none';
            panel.innerHTML = `
                <span id="pet-emoji-header" class="pet-emoji">üêæ</span>
                <span id="pet-food-emoji-header" class="pet-food-emoji">üç£</span>
                <span id="pet-food-count-header" class="pet-food-count">0</span>
            `;
            container.appendChild(panel);
        }

        function updatePetPanel() {
            const panel = document.getElementById('pet-header-panel');
            const emoji = document.getElementById('pet-emoji-header');
            const foodEmoji = document.getElementById('pet-food-emoji-header');
            const count = document.getElementById('pet-food-count-header');
            if (!panel || !emoji || !foodEmoji || !count) return;
            
            if (activePet && score >= 1000) {
                emoji.textContent = activePet.emoji;
                foodEmoji.textContent = activePet.food || 'üç£';
                count.textContent = activePet.rewards || 0;
                panel.style.display = 'flex';
                panel.style.borderColor = activePet.color + '80';
                panel.style.background = `rgba(${hexToRgb(activePet.color)}, 0.15)`;
            } else {
                panel.style.display = 'none';
            }
        }

        // ==================== –£–†–û–í–ï–ù–¨ –ü–û –û–ß–ö–ê–ú ====================
        function updateLevelByScore() {
            if (score < 1500) {
                if (level !== 1) {
                    level = 1;
                    dropInterval = SPEED_TABLE[1];
                }
                return;
            }
            let newLevel = Math.min(15, Math.floor((score - 500) / 1000) + 1);
            if (newLevel !== level) {
                level = newLevel;
                dropInterval = SPEED_TABLE[level] || 220;
                showNotification(`üéâ –£–†–û–í–ï–ù–¨ ${level}!`);
                
                if (level === 7) showNotification('‚ú® –û—Ç–∫—Ä—ã—Ç –∑–æ–ª–æ—Ç–æ–π —Ç–µ—Ç—Ä–∏—Å!');
                if (level === 9) showNotification('üéÜ –û—Ç–∫—Ä—ã—Ç—ã —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∏!');
                if (level === 11) showNotification('üåà –†–∞–¥—É–∂–Ω—ã–µ –±–ª–æ–∫–∏!');
                if (level === 13) showNotification('üëª –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å!');
                if (level === 15) showNotification('üíÄ –†–ï–ñ–ò–ú –ë–û–ì–ê!');
            }
        }

        // ==================== –ê–ù–ò–ú–ê–¶–ò–Ø –ï–î–´ ====================
        function showFoodAnimation(foodEmoji, count, color) {
            for (let i = 0; i < Math.min(count, 8); i++) {
                setTimeout(() => {
                    let el = document.createElement('div');
                    el.className = 'food-particle';
                    el.style.left = (window.innerWidth / 2 - 80 + Math.random() * 160) + 'px';
                    el.style.top = (window.innerHeight / 2 - 80 + Math.random() * 160) + 'px';
                    el.style.color = color || '#FFD700';
                    el.textContent = foodEmoji;
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 1200);
                }, i * 70);
            }
        }

        // ==================== –ü–û–õ–£–ß–ï–ù–ò–ï –ü–ò–¢–û–ú–¶–ê ====================
        function unlockPet(pet) {
            if (userPets.some(p => p.id === pet.id)) return false;
            
            userPets.push({ id: pet.id, rewards: 0 });
            activePet = pet;
            activePet.rewards = 0;
            savePets();
            updatePetPanel();
            showFoodAnimation(pet.food, 5, pet.color);
            
            let div = document.createElement('div');
            div.className = 'pet-unlock';
            div.style.borderLeftColor = pet.color;
            div.innerHTML = `<span style="font-size:2.5rem;">${pet.emoji}</span>
                            <span>‚ú® ${pet.name} –ø–æ–ª—É—á–µ–Ω!<br>
                            <span style="color:${pet.color};">+100 –æ—á–∫–æ–≤</span></span>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
            
            score += 100;
            updateDisplay();
            return true;
        }

        // ==================== –ö–û–†–ú–õ–ï–ù–ò–ï –ü–ò–¢–û–ú–¶–ê ====================
        function feedActivePet(linesCleared) {
            if (!activePet) {
                if (userPets.length) {
                    activePet = PETS.find(p => p.id === userPets[0].id);
                    if (activePet) activePet.rewards = userPets[0].rewards || 0;
                }
                return false;
            }
            let pet = PETS.find(p => p.id === activePet.id);
            if (!pet) return false;
            
            pet.rewards = (pet.rewards || 0) + linesCleared;
            activePet.rewards = pet.rewards;
            
            let userPet = userPets.find(p => p.id === pet.id);
            if (userPet) userPet.rewards = pet.rewards;
            savePets();
            
            showFoodAnimation(pet.food, linesCleared, pet.color);
            updatePetPanel();
            score += linesCleared * 10;
            updateDisplay();
            return true;
        }

        // ==================== –ü–†–û–í–ï–†–ö–ê –ü–ò–¢–û–ú–¶–ï–í ====================
        function checkPetUnlocks() {
            if (!score) return;
            PETS.forEach(pet => {
                if (!userPets.some(p => p.id === pet.id) && score >= pet.score) {
                    unlockPet(pet);
                }
            });
        }

        // ==================== –õ–ò–î–ï–†–ë–û–†–î ====================
        function getPetsCollection(score) {
            if (score < 1000) return { emojis: 'üêæ', count: 0 };
            let count = Math.min(29, Math.floor((score - 500) / 500));
            let allPets = PETS.map(p => p.emoji);
            let collection = [];
            for (let i = 0; i < count; i++) collection.push(allPets[i % allPets.length]);
            
            let displayEmojis = '';
            if (collection.length > 10) {
                displayEmojis = collection.slice(0, 10).join(' ') + ` +${collection.length - 10}`;
            } else {
                displayEmojis = collection.join(' ');
            }
            return { emojis: displayEmojis, count };
        }

        function loadLeaderboard() {
            let el = document.getElementById('leaderboard-list');
            el.innerHTML = '<div style="text-align:center; padding:30px;">üèÜ –ó–ê–ì–†–£–ó–ö–ê...</div>';
            
            fetch('/api/top-players?gameType=tetris&limit=10')
                .then(r => r.json())
                .then(data => {
                    let players = data.players || [];
                    el.innerHTML = '';
                    
                    players.forEach((p, i) => {
                        let isMe = p.user_id === telegramUserId;
                        let col = getPetsCollection(p.best_score || 0);
                        let item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.style.background = isMe ? 'linear-gradient(145deg, rgba(102,204,153,0.2), rgba(77,179,128,0.1))' : '';
                        item.style.borderLeftColor = isMe ? '#66ffaa' : '#ffcc66';
                        
                        item.innerHTML = `
                            <div class="rank">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</div>
                            <div class="player-info">
                                <div class="player-name" style="color:${isMe?'#66ffaa':'white'}">
                                    ${p.display_name || p.username || '–ò–≥—Ä–æ–∫'} ${isMe?'(–í—ã)':''}
                                </div>
                                <div class="player-score">${p.best_score || 0} –æ—á–∫–æ–≤</div>
                                <div class="pets-collection">
                                    <span style="color:#ffd700;">üêæ</span>
                                    <span style="font-size:1.1rem;">${col.emojis}</span>
                                    <span class="pets-count-badge">${col.count}</span>
                                </div>
                                ${p.city ? `<div style="color:#aaccff; margin-top:6px;">üìç ${p.city}</div>` : ''}
                            </div>
                        `;
                        el.appendChild(item);
                    });
                })
                .catch(() => {
                    el.innerHTML = '<div style="padding:30px; color:#ff6666; text-align:center;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                });
        }

        // ==================== –¢–í–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ó NEON ====================
        function loadUserStats() {
            let el = document.getElementById('user-stats');
            if (!el) return;
            
            el.innerHTML = '<div style="text-align:center; padding:20px;">üìä –ó–ê–ì–†–£–ó–ö–ê...</div>';
            
            fetch(`/api/user-stats?telegramId=${telegramUserId}&gameType=tetris`)
                .then(r => r.json())
                .then(d => {
                    if (d.success && d.stats) {
                        let s = d.stats;
                        el.innerHTML = `
                            <div class="stat-row">
                                <span class="stat-label">üèÜ –õ—É—á—à–∏–π —Å—á–µ—Ç</span>
                                <span class="stat-value">${s.best_score || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">üìä –†–µ–∫–æ—Ä–¥–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</span>
                                <span class="stat-value">${s.best_level || 1}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">üî∑ –í—Å–µ–≥–æ –ª–∏–Ω–∏–π</span>
                                <span class="stat-value">${s.best_lines || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">üéÆ –°—ã–≥—Ä–∞–Ω–æ –∏–≥—Ä</span>
                                <span class="stat-value">${s.games_played || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">üìà –°—Ä–µ–¥–Ω–∏–π —Å—á–µ—Ç</span>
                                <span class="stat-value">${Math.round(s.avg_score || 0)}</span>
                            </div>
                        `;
                        updatePetsStats();
                    }
                })
                .catch(() => {
                    el.innerHTML = '<div style="color:#ff6666; padding:20px; text-align:center;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
                });
        }

        // ==================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–ò–¢–û–ú–¶–ï–í ====================
        function updatePetsStats() {
            let container = document.getElementById('user-stats');
            if (!container) return;
            
            let old = document.querySelector('.pets-stats-block');
            if (old) old.remove();
            
            if (userPets.length === 0) {
                let emptyBlock = document.createElement('div');
                emptyBlock.className = 'pets-stats-block';
                emptyBlock.innerHTML = '<div style="display:flex; align-items:center; gap:15px; padding:10px;">' +
                    '<span style="font-size:2.5rem;">üêæ</span>' +
                    '<span style="font-size:1rem;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤.<br>–ù–∞–±–µ—Ä–∏—Ç–µ 1000 –æ—á–∫–æ–≤!</span></div>';
                container.appendChild(emptyBlock);
                return;
            }
            
            let block = document.createElement('div');
            block.className = 'pets-stats-block';
            block.innerHTML = '<h3 style="color:#ff99aa; margin-bottom:15px;">üêæ –ú–û–Ø –ö–û–õ–õ–ï–ö–¶–ò–Ø</h3>';
            
            let sorted = PETS.filter(p => userPets.some(u => u.id === p.id))
                           .sort((a,b) => (b.rewards||0) - (a.rewards||0));
            
            sorted.slice(0, 8).forEach(pet => {
                block.innerHTML += `<div class="pet-stat-row">
                    <span style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:1.6rem;">${pet.emoji}</span>
                        <span>${pet.name}</span>
                        ${activePet?.id === pet.id ? '<span style="color:#ffd700;">‚≠ê</span>' : ''}
                    </span>
                    <span style="color:${pet.color}; font-weight:bold; background:rgba(0,0,0,0.3); padding:5px 15px; border-radius:30px;">
                        ${pet.rewards || 0} ${pet.food}
                    </span>
                </div>`;
            });
            
            if (sorted.length > 8) {
                block.innerHTML += `<div style="text-align:center; margin-top:12px; color:#aaccff;">–∏ –µ—â–µ ${sorted.length - 8} –ø–∏—Ç–æ–º—Ü–µ–≤...</div>`;
            }
            
            container.appendChild(block);
        }

        // ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ====================
        function showScreen(screenName) {
            Object.keys(screens).forEach(key => screens[key].classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        function showMenu() {
            showScreen('menu');
            if (gameActive && !gamePaused) {
                togglePause();
            }
        }

        function startGame() {
            if (animationId) cancelAnimationFrame(animationId);
            
            board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            score = 0;
            level = 1;
            lines = 0;
            totalLines = 0;
            gameActive = true;
            gamePaused = false;
            gameOver = false;
            dropInterval = SPEED_TABLE[1];
            pieceQueue = [];
            clearedLinesAnimation = [];
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –°–û–•–†–ê–ù–ò–¢–¨
            updateSaveButton('save');
            
            generatePieceQueue();
            updateDisplay();
            spawnPiece();
            
            if (!gameOver) {
                drawBoard();
                showScreen('game');
                lastTime = 0;
                dropCounter = 0;
                animationId = requestAnimationFrame(gameLoop);
                showNotification('üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!');
            }
        }

        function initGame() {
            board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            score = 0;
            level = 1;
            lines = 0;
            gameActive = true;
            gamePaused = false;
            gameOver = false;
            dropInterval = SPEED_TABLE[1];
            clearedLinesAnimation = [];
            pieceQueue = [];
            
            generatePieceQueue();
            updateDisplay();
            spawnPiece();
            drawBoard();
            
            if (animationId) cancelAnimationFrame(animationId);
            lastTime = 0;
            dropCounter = 0;
            animationId = requestAnimationFrame(gameLoop);
            updateSaveButton('save');
        }

        function generatePieceQueue() {
            pieceQueue = [];
            for (let i = 0; i < 3; i++) {
                pieceQueue.push(Math.floor(Math.random() * SHAPES.length));
            }
        }

        function spawnPiece() {
            if (!pieceQueue.length) generatePieceQueue();
            let id = pieceQueue.shift();
            pieceQueue.push(Math.floor(Math.random() * SHAPES.length));
            
            currentPiece = {
                shape: SHAPES[id],
                color: COLORS[id]
            };
            currentX = Math.floor(COLS / 2) - Math.floor(currentPiece.shape[0].length / 2);
            currentY = 0;
            
            if (collide(currentPiece, currentX, currentY)) {
                gameOver = true;
                saveGameToDB(true);
                showNotification('üéØ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á–µ—Ç: ' + score);
                updateSaveButton('save');
                setTimeout(() => {
                    showMenu();
                    loadUserStats();
                }, 1500);
            }
        }

        function collide(piece, x, y) {
            for (let r = 0; r < piece.shape.length; r++) {
                for (let c = 0; c < piece.shape[r].length; c++) {
                    if (piece.shape[r][c]) {
                        let nx = x + c, ny = y + r;
                        if (nx < 0 || nx >= COLS || ny >= ROWS) return true;
                        if (ny >= 0 && board[ny] && board[ny][nx]) return true;
                    }
                }
            }
            return false;
        }

        function mergePiece() {
            for (let y = 0; y < currentPiece.shape.length; y++) {
                for (let x = 0; x < currentPiece.shape[y].length; x++) {
                    if (currentPiece.shape[y][x] && currentY + y >= 0) {
                        board[currentY + y][currentX + x] = currentPiece.color;
                    }
                }
            }
        }

        function moveDown() {
            if (gameOver || gamePaused) return;
            if (!collide(currentPiece, currentX, currentY + 1)) {
                currentY++;
            } else {
                mergePiece();
                checkLines();
                spawnPiece();
            }
            drawBoard();
        }

        function moveLeft() {
            if (!gameOver && !gamePaused && !collide(currentPiece, currentX - 1, currentY)) {
                currentX--;
                drawBoard();
            }
        }

        function moveRight() {
            if (!gameOver && !gamePaused && !collide(currentPiece, currentX + 1, currentY)) {
                currentX++;
                drawBoard();
            }
        }

        function rotatePiece() {
            if (gameOver || gamePaused) return;
            let rotated = currentPiece.shape[0].map((_, i) => 
                currentPiece.shape.map(row => row[i]).reverse()
            );
            let orig = currentPiece.shape;
            currentPiece.shape = rotated;
            if (collide(currentPiece, currentX, currentY)) {
                currentPiece.shape = orig;
            }
            drawBoard();
        }

        function hardDrop() {
            if (gameOver || gamePaused) return;
            let dist = 0;
            while (!collide(currentPiece, currentX, currentY + 1)) {
                currentY++;
                dist++;
            }
            score += dist * 2;
            mergePiece();
            checkLines();
            spawnPiece();
            updateDisplay();
            drawBoard();
        }

        function checkLines() {
            let cleared = 0, rows = [];
            for (let y = ROWS - 1; y >= 0; y--) {
                if (board[y].every(c => c !== 0)) {
                    rows.push(y);
                    cleared++;
                }
            }
            
            if (cleared > 0) {
                lines += cleared;
                totalLines += cleared;
                clearedLinesAnimation = rows;
                
                let bonus = [0, 100, 300, 500, 800];
                score += bonus[cleared] * level;
                
                feedActivePet(cleared);
                
                if (cleared === 4) {
                    showNotification('üéØ –¢–ï–¢–†–ò–°! +' + (800 * level));
                    if (level >= 7) showNotification('‚ú® –ó–û–õ–û–¢–û–ô –¢–ï–¢–†–ò–°!');
                    if (level >= 9) {
                        for (let i = 0; i < 10; i++) {
                            setTimeout(() => {
                                let f = document.createElement('div');
                                f.className = 'food-particle';
                                f.style.left = Math.random() * window.innerWidth + 'px';
                                f.style.top = Math.random() * window.innerHeight * 0.3 + 'px';
                                f.style.fontSize = '2.5rem';
                                f.style.color = ['#FFD700','#FFA500','#FF69B4','#00FFFF'][Math.floor(Math.random()*4)];
                                f.innerHTML = 'üéÜ';
                                document.body.appendChild(f);
                                setTimeout(() => f.remove(), 1000);
                            }, i * 50);
                        }
                    }
                }
                
                setTimeout(() => {
                    rows.sort((a, b) => a - b).forEach(y => {
                        board.splice(y, 1);
                        board.unshift(Array(COLS).fill(0));
                    });
                    clearedLinesAnimation = [];
                    updateDisplay();
                    drawBoard();
                }, 400);
                
                updateDisplay();
            }
        }

        function togglePause() {
            if (gameActive && !gameOver) {
                gamePaused = !gamePaused;
                if (gamePaused) {
                    cancelAnimationFrame(animationId);
                    showNotification('‚è∏ –ü–∞—É–∑–∞');
                } else {
                    lastTime = 0;
                    dropCounter = 0;
                    animationId = requestAnimationFrame(gameLoop);
                    showNotification('‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º');
                }
            }
        }

        function restartGame() {
            if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
                initGame();
                showNotification('üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞');
                updateSaveButton('save');
            }
        }

        function updateDisplay() {
            document.getElementById('level-display').textContent = level;
            document.getElementById('score-display').textContent = score;
            document.getElementById('lines-display').textContent = lines;
            
            updateLevelByScore();
            checkPetUnlocks();
            updatePetPanel();
        }

        // ==================== –ö–ù–û–ü–ö–ê –°–û–•–†–ê–ù–ò–¢–¨/–ü–†–û–î–û–õ–ñ–ò–¢–¨ ====================
        function updateSaveButton(mode) {
            const btn = document.getElementById('saveContinueBtn');
            if (!btn) return;
            
            if (mode === 'continue') {
                btn.innerHTML = '‚ñ∂Ô∏è –ü–†–û–î–û–õ–ñ–ò–¢–¨';
                btn.classList.remove('save-btn');
                btn.classList.add('continue-btn');
                btn.onclick = continueGame;
            } else {
                btn.innerHTML = 'üíæ –°–û–•–†–ê–ù–ò–¢–¨';
                btn.classList.remove('continue-btn');
                btn.classList.add('save-btn');
                btn.onclick = saveGameScore;
            }
        }

        function continueGame() {
            if (gamePaused) {
                togglePause();
            }
            updateSaveButton('save');
        }

        async function saveGameScore() {
            const btn = document.getElementById('saveContinueBtn');
            
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = '', 200);
            }
            
            const wasActive = gameActive && !gameOver;
            const wasPaused = gamePaused;
            
            if (wasActive && !gamePaused) {
                togglePause();
            }
            
            showNotification('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º...');
            
            const result = await saveGameToDB(false);
            
            if (result.success) {
                showNotification('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                loadUserStats();
                updateSaveButton('continue');
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        async function saveGameToDB(gameOverFlag = false) {
            try {
                const response = await fetch('/api/save-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'tetris_score',
                        gameType: 'tetris',
                        score: score,
                        level: level,
                        lines: lines,
                        gameOver: gameOverFlag,
                        telegramId: telegramUserId,
                        username: telegramUsername
                    })
                });
                const result = await response.json();
                return { success: response.ok, ...result };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                return { success: false };
            }
        }

        // ==================== –û–¢–†–ò–°–û–í–ö–ê ====================
        function drawBoard() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –°–ï–¢–ö–ê - –¢–í–û–Ø –û–†–ò–ì–ò–ù–ê–õ–¨–ù–ê–Ø!
            ctx.strokeStyle = 'rgba(106, 91, 255, 0.25)';
            ctx.lineWidth = 1;
            
            for (let x = 0; x <= COLS; x++) {
                ctx.beginPath();
                ctx.moveTo(x * BLOCK_SIZE, 0);
                ctx.lineTo(x * BLOCK_SIZE, ROWS * BLOCK_SIZE);
                ctx.stroke();
            }
            
            for (let y = 0; y <= ROWS; y++) {
                ctx.beginPath();
                ctx.moveTo(0, y * BLOCK_SIZE);
                ctx.lineTo(COLS * BLOCK_SIZE, y * BLOCK_SIZE);
                ctx.stroke();
            }
            
            // –ë–õ–û–ö–ò
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (board[y][x]) {
                        drawBlock(x, y, board[y][x], false);
                    }
                }
            }
            
            if (clearedLinesAnimation.length) {
                ctx.globalAlpha = 0.7;
                clearedLinesAnimation.forEach(y => {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, y * BLOCK_SIZE, COLS * BLOCK_SIZE, BLOCK_SIZE);
                });
                ctx.globalAlpha = 1;
            }
            
            if (currentPiece) {
                for (let y = 0; y < currentPiece.shape.length; y++) {
                    for (let x = 0; x < currentPiece.shape[y].length; x++) {
                        if (currentPiece.shape[y][x]) {
                            drawBlock(currentX + x, currentY + y, currentPiece.color, true);
                        }
                    }
                }
            }
        }

        function drawBlock(x, y, color, isCurrent) {
            let s = BLOCK_SIZE;
            let xx = x * s;
            let yy = y * s;
            
            ctx.fillStyle = color;
            ctx.fillRect(xx, yy, s, s);
            
            let grad = ctx.createLinearGradient(xx, yy, xx + s, yy + s);
            grad.addColorStop(0, lightenColor(color, 20));
            grad.addColorStop(0.7, color);
            
            ctx.fillStyle = grad;
            ctx.fillRect(xx, yy, s, s);
            
            ctx.strokeStyle = darkenColor(color, 30);
            ctx.lineWidth = 1;
            ctx.strokeRect(xx, yy, s, s);
            
            if (isCurrent) {
                ctx.strokeStyle = lightenColor(color, 50);
                ctx.lineWidth = 3;
                ctx.strokeRect(xx + 2, yy + 2, s - 4, s - 4);
            }
            
            if (level >= 11) {
                ctx.shadowColor = color;
                ctx.shadowBlur = 8;
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(xx, yy, s, s);
                ctx.shadowBlur = 0;
            }
        }

        function lightenColor(color, percent) {
            let num = parseInt(color.slice(1), 16);
            let amt = Math.round(2.55 * percent);
            let R = Math.min(255, (num >> 16) + amt);
            let G = Math.min(255, (num >> 8 & 0x00FF) + amt);
            let B = Math.min(255, (num & 0x0000FF) + amt);
            return `rgb(${R}, ${G}, ${B})`;
        }

        function darkenColor(color, percent) {
            let num = parseInt(color.slice(1), 16);
            let amt = Math.round(2.55 * percent);
            let R = Math.max(0, (num >> 16) - amt);
            let G = Math.max(0, (num >> 8 & 0x00FF) - amt);
            let B = Math.max(0, (num & 0x0000FF) - amt);
            return `rgb(${R}, ${G}, ${B})`;
        }

        function hexToRgb(hex) {
            if (hex.length === 4) {
                return `${parseInt(hex[1] + hex[1], 16)}, ${parseInt(hex[2] + hex[2], 16)}, ${parseInt(hex[3] + hex[3], 16)}`;
            }
            if (hex.length === 7) {
                return `${parseInt(hex[1] + hex[2], 16)}, ${parseInt(hex[3] + hex[4], 16)}, ${parseInt(hex[5] + hex[6], 16)}`;
            }
            return '255, 182, 193';
        }

        function gameLoop(time) {
            if (gameOver || gamePaused) return;
            let delta = time - lastTime;
            lastTime = time;
            dropCounter += delta;
            if (dropCounter > dropInterval) {
                moveDown();
                dropCounter = 0;
            }
            drawBoard();
            animationId = requestAnimationFrame(gameLoop);
        }

        function showNotification(message) {
            let n = document.getElementById('notification');
            n.textContent = message;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 2000);
        }

        // ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================
        function showStats() {
            loadUserStats();
            showScreen('stats');
        }

        function showLeaderboard() {
            loadLeaderboard();
            showScreen('leaderboard');
        }

        function showSettings() {
            showScreen('settings');
        }

        function testDatabase() {
            let el = document.getElementById('db-status-text');
            if (el) {
                el.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                el.style.color = '#66ffaa';
            }
            showNotification('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
        }

        // ==================== KEYBOARD ====================
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('keyboard-controls')?.checked) return;
            
            switch(e.key) {
                case 'ArrowLeft': e.preventDefault(); moveLeft(); break;
                case 'ArrowRight': e.preventDefault(); moveRight(); break;
                case 'ArrowDown': e.preventDefault(); moveDown(); break;
                case 'ArrowUp': e.preventDefault(); rotatePiece(); break;
                case ' ': e.preventDefault(); hardDrop(); break;
                case 'p': case 'P': e.preventDefault(); togglePause(); break;
                case 'Escape': e.preventDefault(); showMenu(); break;
                case 'r': case 'R': e.preventDefault(); restartGame(); break;
            }
        });

        // ==================== –ê–î–ê–ü–¢–ê–¶–ò–Ø ====================
        function adaptCanvasSize() {
            let area = document.querySelector('.game-area');
            if (!area) return;
            let w = area.clientWidth - 10;
            let h = area.clientHeight - 10;
            let scale = Math.min(w / (COLS * BLOCK_SIZE), h / (ROWS * BLOCK_SIZE), 1.3);
            canvas.style.width = Math.floor(COLS * BLOCK_SIZE * scale) + 'px';
            canvas.style.height = Math.floor(ROWS * BLOCK_SIZE * scale) + 'px';
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        function init() {
            console.log('üöÄ –¢–ï–¢–†–ò–° PRO - –ü–∏—Ç–æ–º—Ü—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');
            
            loadPets();
            createPetPanel();
            updatePetPanel();
            
            board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            drawBoard();
            
            adaptCanvasSize();
            window.addEventListener('resize', adaptCanvasSize);
            
            document.getElementById('db-status-text').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            
            if (telegramUserId) {
                setTimeout(() => loadUserStats(), 200);
            }
            
            showNotification('üêæ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
