<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Ç—Ä–∏—Å Telegram</title>
    <style>
        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
        }
        
        /* HEADER */
        .header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #00b4db, #0083b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        
        .user-info {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px auto;
            max-width: 400px;
        }
        
        .user-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .user-label {
            color: #8b9dc3;
            font-size: 0.9rem;
        }
        
        .user-value {
            font-weight: 600;
            color: #00b4db;
            font-family: 'Courier New', monospace;
        }
        
        .user-value.city {
            color: #4CAF50;
        }
        
        /* –ö–ù–û–ü–ö–ò */
        .btn-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .btn-large {
            grid-column: span 2;
            padding: 18px;
            font-size: 1.1rem;
        }
        
        /* –≠–ö–†–ê–ù–´ */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #8b9dc3;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00b4db;
        }
        
        /* CANVAS */
        #game-canvas {
            display: block;
            margin: 0 auto 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            background: rgba(0,0,0,0.5);
            max-width: 100%;
        }
        
        /* –£–ü–†–ê–í–õ–ï–ù–ò–ï */
        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            background: rgba(0,180,219,0.2);
            border: 1px solid rgba(0,180,219,0.3);
            color: white;
            padding: 15px 5px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:active {
            background: rgba(0,180,219,0.4);
            transform: scale(0.95);
        }
        
        /* –°–¢–ê–¢–ò–°–¢–ò–ö–ê */
        .stats-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00b4db;
        }
        
        .stat-card .stat-label {
            color: #8b9dc3;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .stat-card .stat-value {
            font-size: 1.5rem;
            color: #4CAF50;
        }
        
        /* –õ–ò–î–ï–†–ë–û–†–î */
        .leaderboard {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border-left: 4px solid #00b4db;
            transition: all 0.2s;
        }
        
        .leaderboard-item:hover {
            background: rgba(0,0,0,0.4);
            transform: translateX(5px);
        }
        
        .leaderboard-item.current {
            background: rgba(0,180,219,0.2);
            border-left-color: #4CAF50;
        }
        
        .rank {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f0c420;
            min-width: 40px;
            text-align: center;
        }
        
        .player-info {
            flex: 1;
            margin: 0 15px;
        }
        
        .player-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .player-city {
            font-size: 0.8rem;
            color: #8b9dc3;
        }
        
        .player-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00b4db;
        }
        
        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(33, 150, 83, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .notification.error {
            background: rgba(220, 53, 69, 0.95);
        }
        
        .notification.warning {
            background: rgba(255, 193, 7, 0.95);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* DEBUG INFO */
        .debug-panel {
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #8b9dc3;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .debug-title {
            color: #f0c420;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .debug-entry {
            margin-bottom: 3px;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .debug-time {
            color: #8b9dc3;
            margin-right: 10px;
        }
        
        .debug-message {
            color: white;
        }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 600px) {
            .btn-container { grid-template-columns: 1fr; }
            .btn-large { grid-column: span 1; }
            .controls { grid-template-columns: repeat(2, 1fr); }
            .stats-panel { grid-template-columns: repeat(3, 1fr); }
            .stats-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
        <div class="screen active" id="menu-screen">
            <div class="header">
                <h1>üéÆ –¢–ï–¢–†–ò–° TELEGRAM</h1>
                <p>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö Neon PostgreSQL</p>
                
                <div class="user-info">
                    <div class="user-row">
                        <span class="user-label">–ò–º—è:</span>
                        <span class="user-value" id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <div class="user-row">
                        <span class="user-label">ID:</span>
                        <span class="user-value" id="user-id">...</span>
                    </div>
                    <div class="user-row">
                        <span class="user-label">–ì–æ—Ä–æ–¥:</span>
                        <span class="user-value city" id="user-city">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                    </div>
                    <div class="user-row">
                        <span class="user-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</span>
                        <span class="user-value" id="user-platform">...</span>
                    </div>
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-primary btn-large" onclick="startGame()">
                    üéÆ –ù–û–í–ê–Ø –ò–ì–†–ê
                </button>
                
                <button class="btn" onclick="loadUserStats(true)">
                    üìä –ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
                </button>
                
                <button class="btn" onclick="loadLeaderboard()">
                    üèÜ –õ–ò–î–ï–†–ë–û–†–î
                </button>
                
                <button class="btn" onclick="showCityInput()">
                    üèôÔ∏è –£–ö–ê–ó–ê–¢–¨ –ì–û–†–û–î
                </button>
                
                <button class="btn btn-warning" onclick="testDatabase()">
                    üîó –¢–ï–°–¢ –ë–ê–ó–´ –î–ê–ù–ù–´–•
                </button>
                
                <button class="btn btn-danger" onclick="testTelegramBot()">
                    ü§ñ –¢–ï–°–¢ –ë–û–¢–ê TELEGRAM
                </button>
            </div>
            
            <div class="debug-panel">
                <div class="debug-title">–õ–û–ì:</div>
                <div id="debug-log"></div>
            </div>
        </div>
        
        <!-- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù -->
        <div class="screen" id="game-screen">
            <div class="game-header">
                <button class="btn" onclick="backToMenu()" style="padding: 8px 15px;">
                    ‚Üê –ú–ï–ù–Æ
                </button>
                <div style="text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: bold;">–°—á–µ—Ç: <span id="current-score">0</span></div>
                    <div style="font-size: 0.9rem; color: #8b9dc3;">–£—Ä–æ–≤–µ–Ω—å: <span id="current-level">1</span></div>
                </div>
                <button class="btn" onclick="saveGameScore()" style="padding: 8px 15px;">
                    üíæ –°–û–•–†–ê–ù–ò–¢–¨
                </button>
            </div>
            
            <div class="stats-panel">
                <div class="stat-box">
                    <div class="stat-label">–£–†–û–í–ï–ù–¨</div>
                    <div class="stat-value" id="level">1</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">–û–ß–ö–ò</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">–õ–ò–ù–ò–ò</div>
                    <div class="stat-value" id="lines">0</div>
                </div>
            </div>
            
            <canvas id="game-canvas" width="300" height="600"></canvas>
            
            <div class="controls">
                <button class="control-btn" onclick="moveLeft()">‚Üê</button>
                <button class="control-btn" onclick="rotatePiece()">‚Üª</button>
                <button class="control-btn" onclick="moveRight()">‚Üí</button>
                <button class="control-btn" onclick="hardDrop()">‚Üì</button>
                <button class="control-btn" onclick="pauseGame()" style="grid-column: span 2;">‚è∏ –ü–ê–£–ó–ê</button>
                <button class="control-btn" onclick="restartGame()" style="grid-column: span 2;">üîÑ –ó–ê–ù–û–í–û</button>
            </div>
        </div>
        
        <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
        <div class="screen" id="stats-screen">
            <div class="header">
                <h1>üìä –ú–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê</h1>
                <button class="btn" onclick="backToMenu()" style="margin-top: 10px; padding: 8px 20px;">
                    ‚Üê –ù–ê–ó–ê–î
                </button>
            </div>
            
            <div class="stats-container">
                <div class="stats-grid" id="user-stats">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <div class="btn-container">
                <button class="btn" onclick="loadUserStats(true)">
                    üîÑ –û–ë–ù–û–í–ò–¢–¨
                </button>
                <button class="btn" onclick="clearLocalStats()">
                    üóëÔ∏è –û–ß–ò–°–¢–ò–¢–¨ –ö–≠–®
                </button>
            </div>
        </div>
        
        <!-- –õ–ò–î–ï–†–ë–û–†–î -->
        <div class="screen" id="leaderboard-screen">
            <div class="header">
                <h1>üèÜ –õ–ò–î–ï–†–ë–û–†–î</h1>
                <button class="btn" onclick="backToMenu()" style="margin-top: 10px; padding: 8px 20px;">
                    ‚Üê –ù–ê–ó–ê–î
                </button>
            </div>
            
            <div class="leaderboard" id="leaderboard-content">
                <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï -->
    <div class="notification" id="notification"></div>

    <script>
        // ==================== –ö–û–ù–°–¢–ê–ù–¢–´ ====================
        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 30;
        const COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
        const SHAPES = [
            [[1,1,1,1]],
            [[1,1],[1,1]],
            [[0,1,0],[1,1,1]],
            [[1,1,0],[0,1,1]],
            [[0,1,1],[1,1,0]],
            [[1,0,0],[1,1,1]],
            [[0,0,1],[1,1,1]]
        ];

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let tg = null;
        let telegramUser = null;
        let userId = null;
        let username = '–ò–≥—Ä–æ–∫';
        let userCity = '–ù–µ —É–∫–∞–∑–∞–Ω';
        let board = [];
        let currentPiece = null;
        let currentX = 0;
        let currentY = 0;
        let score = 0;
        let level = 1;
        let lines = 0;
        let gameActive = false;
        let gamePaused = false;
        let gameOver = false;
        let dropInterval = 1000;
        let lastTime = 0;
        let dropCounter = 0;
        let animationId = null;
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ====================
        function initTelegram() {
            addDebug('üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp...');
            
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                addDebug('‚úÖ Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
                
                // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                tg.expand();
                addDebug('üì± WebApp —Ä–∞—Å—à–∏—Ä–µ–Ω');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const initData = tg.initDataUnsafe || {};
                addDebug('üìä InitData –ø–æ–ª—É—á–µ–Ω—ã', initData);
                
                if (initData.user) {
                    telegramUser = initData.user;
                    userId = String(telegramUser.id);
                    username = telegramUser.username || 
                              telegramUser.first_name || 
                              'Telegram Player';
                    
                    // –ü–æ–ª—É—á–∞–µ–º –≥–æ—Ä–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (initData.user.city) {
                        userCity = initData.user.city;
                    }
                    
                    addDebug('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram:', {
                        id: userId,
                        username: username,
                        firstName: telegramUser.first_name,
                        city: userCity
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    updateUserUI();
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ Telegram
                    setupTelegramButtons();
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
                    sendStartDataToBot();
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    setTimeout(() => loadUserStats(), 1000);
                    
                    return true;
                } else {
                    addDebug('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ initData');
                    userId = 'web_' + Date.now();
                    username = 'Web Player';
                    updateUserUI();
                }
            } else {
                addDebug('‚ùå Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
                userId = 'web_' + Date.now();
                username = 'Web Player';
                updateUserUI();
            }
            return false;
        }

        function updateUserUI() {
            document.getElementById('user-name').textContent = username;
            document.getElementById('user-id').textContent = userId;
            document.getElementById('user-city').textContent = userCity;
            document.getElementById('user-platform').textContent = tg ? tg.platform : 'Browser';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–æ—Ä–æ–¥ –≤ localStorage
            if (userCity && userCity !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
                localStorage.setItem('tetris_city', userCity);
            }
        }

        function setupTelegramButtons() {
            if (!tg) return;
            
            // –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                addDebug('‚Üê –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥');
                if (gameActive && !gamePaused) {
                    pauseGame();
                    showNotification('‚è∏ –ò–≥—Ä–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                }
                backToMenu();
            });
            
            addDebug('‚úÖ –ö–Ω–æ–ø–∫–∏ Telegram –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
        }

        // ==================== –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –í –ë–û–¢–ê TELEGRAM ====================
        async function sendDataToTelegramBot(data) {
            if (!tg || !tg.sendData) {
                addDebug('‚ö†Ô∏è tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', data);
                return { success: false, error: 'Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' };
            }
            
            try {
                addDebug('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram –±–æ—Ç–∞:', data);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram WebApp
                tg.sendData(JSON.stringify(data));
                
                addDebug('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram –±–æ—Ç–∞');
                return { success: true };
            } catch (error) {
                addDebug('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
                return { success: false, error: error.message };
            }
        }

        async function sendGameDataToBot(gameData) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–æ—Ç–∞
            const botData = {
                action: 'game_result',
                source: 'tetris_webapp',
                userId: userId,
                user_id: userId,
                username: username,
                userCity: userCity,
                gameType: 'tetris',
                score: gameData.score,
                level: gameData.level,
                lines: gameData.lines,
                gameOver: gameData.gameOver || false,
                timestamp: new Date().toISOString(),
                platform: tg ? tg.platform : 'web',
                version: tg ? tg.version : '1.0'
            };
            
            // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram –±–æ—Ç–∞
            const telegramResult = await sendDataToTelegramBot(botData);
            
            // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
            const dbResult = await saveToDatabase(botData);
            
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            saveToLocalStorage(botData);
            
            return {
                telegram: telegramResult,
                database: dbResult,
                localStorage: true
            };
        }

        async function saveToDatabase(gameData) {
            try {
                addDebug('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...', gameData);
                
                const response = await fetch('/api/save-game', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(gameData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addDebug('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î:', result);
                
                return { success: true, data: result };
            } catch (error) {
                addDebug('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î:', error.message);
                return { success: false, error: error.message };
            }
        }

        // ==================== –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• ====================
        async function loadUserStats(showScreen = false) {
            try {
                addDebug('üìä –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                
                const response = await fetch(`/api/user-stats?userId=${encodeURIComponent(userId)}&gameType=tetris`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                addDebug('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞:', result);
                
                if (result.success && result.stats) {
                    displayUserStats(result.stats);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –µ—Å–ª–∏ –µ—Å—Ç—å –≤ –ë–î
                    if (result.stats.city && result.stats.city !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
                        userCity = result.stats.city;
                        localStorage.setItem('tetris_city', userCity);
                        updateUserUI();
                    }
                    
                    if (showScreen) {
                        showScreenById('stats-screen');
                    }
                } else {
                    showNotification('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'warning');
                    displayDefaultStats();
                }
            } catch (error) {
                addDebug('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error.message);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É', 'error');
                loadLocalStats();
            }
        }

        function displayUserStats(stats) {
            const statsGrid = document.getElementById('user-stats');
            if (!statsGrid) return;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">–õ—É—á—à–∏–π —Å—á–µ—Ç</div>
                    <div class="stat-value">${stats.best_score || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å</div>
                    <div class="stat-value">${stats.best_level || 1}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–í—Å–µ–≥–æ –ª–∏–Ω–∏–π</div>
                    <div class="stat-value">${stats.total_lines || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
                    <div class="stat-value">${stats.games_played || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Å—á–µ—Ç</div>
                    <div class="stat-value">${Math.round(stats.avg_score || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ì–æ—Ä–æ–¥</div>
                    <div class="stat-value">${stats.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                </div>
            `;
        }

        async function loadLeaderboard() {
            try {
                addDebug('üèÜ –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏–¥–µ—Ä–±–æ—Ä–¥...');
                
                const response = await fetch('/api/leaderboard?gameType=tetris&limit=10');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                addDebug('üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –ø–æ–ª—É—á–µ–Ω:', result);
                
                if (result.success && result.players) {
                    displayLeaderboard(result.players);
                    showScreenById('leaderboard-screen');
                } else {
                    showNotification('–õ–∏–¥–µ—Ä–±–æ—Ä–¥ –ø—É—Å—Ç', 'warning');
                }
            } catch (error) {
                addDebug('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞:', error.message);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥', 'error');
            }
        }

        function displayLeaderboard(players) {
            const leaderboard = document.getElementById('leaderboard-content');
            if (!leaderboard) return;
            
            if (!players || players.length === 0) {
                leaderboard.innerHTML = '<div style="text-align: center; padding: 40px; color: #8b9dc3;">–õ–∏–¥–µ—Ä–±–æ—Ä–¥ –ø—É—Å—Ç</div>';
                return;
            }
            
            leaderboard.innerHTML = '';
            
            players.forEach((player, index) => {
                const isCurrentUser = String(player.user_id) === userId;
                const item = document.createElement('div');
                item.className = `leaderboard-item ${isCurrentUser ? 'current' : ''}`;
                
                item.innerHTML = `
                    <div class="rank">${index + 1}</div>
                    <div class="player-info">
                        <div class="player-name">
                            ${player.username || `–ò–≥—Ä–æ–∫ ${player.user_id?.slice(-4) || '??'}`}
                            ${isCurrentUser ? ' (–í—ã)' : ''}
                        </div>
                        <div class="player-city">${player.city || '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                    <div class="player-score">${player.score || 0}</div>
                `;
                
                leaderboard.appendChild(item);
            });
        }

        // ==================== –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ====================
        function initGame() {
            addDebug('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã');
            
            board = Array.from({length: ROWS}, () => Array(COLS).fill(0));
            score = 0;
            level = 1;
            lines = 0;
            gameActive = true;
            gamePaused = false;
            gameOver = false;
            dropInterval = 1000;
            
            updateDisplay();
            spawnPiece();
            drawBoard();
            
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            lastTime = 0;
            dropCounter = 0;
            animationId = requestAnimationFrame(gameLoop);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
            sendGameDataToBot({
                action: 'game_start',
                score: 0,
                level: 1,
                lines: 0,
                gameOver: false
            });
            
            showScreenById('game-screen');
            showNotification('üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!');
        }

        function spawnPiece() {
            const shapeId = Math.floor(Math.random() * SHAPES.length);
            currentPiece = {
                shape: SHAPES[shapeId],
                color: COLORS[shapeId]
            };
            currentX = Math.floor(COLS / 2) - Math.floor(currentPiece.shape[0].length / 2);
            currentY = 0;
            
            if (collide()) {
                gameOver = true;
                endGame();
            }
        }

        function collide(x = currentX, y = currentY, shape = currentPiece.shape) {
            for (let row = 0; row < shape.length; row++) {
                for (let col = 0; col < shape[row].length; col++) {
                    if (shape[row][col]) {
                        const boardX = x + col;
                        const boardY = y + row;
                        
                        if (boardX < 0 || boardX >= COLS || boardY >= ROWS) {
                            return true;
                        }
                        
                        if (boardY >= 0 && board[boardY][boardX]) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        function mergePiece() {
            for (let row = 0; row < currentPiece.shape.length; row++) {
                for (let col = 0; col < currentPiece.shape[row].length; col++) {
                    if (currentPiece.shape[row][col]) {
                        const boardY = currentY + row;
                        const boardX = currentX + col;
                        
                        if (boardY >= 0) {
                            board[boardY][boardX] = currentPiece.color;
                        }
                    }
                }
            }
        }

        function checkLines() {
            let linesCleared = 0;
            
            for (let y = ROWS - 1; y >= 0; y--) {
                if (board[y].every(cell => cell !== 0)) {
                    linesCleared++;
                    board.splice(y, 1);
                    board.unshift(Array(COLS).fill(0));
                }
            }
            
            if (linesCleared > 0) {
                lines += linesCleared;
                const bonus = [0, 100, 300, 500, 800];
                score += bonus[linesCleared] * level;
                
                if (lines >= level * 10) {
                    level++;
                    dropInterval = Math.max(100, dropInterval - 100);
                    showNotification(`üéâ –£—Ä–æ–≤–µ–Ω—å ${level}!`);
                }
                
                updateDisplay();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞
                sendGameDataToBot({
                    action: 'score_update',
                    score: score,
                    level: level,
                    lines: lines,
                    linesCleared: linesCleared,
                    gameOver: false
                });
            }
        }

        function moveLeft() { if (!collide(currentX - 1, currentY)) currentX--; drawBoard(); }
        function moveRight() { if (!collide(currentX + 1, currentY)) currentX++; drawBoard(); }
        
        function moveDown() {
            if (!collide(currentX, currentY + 1)) {
                currentY++;
            } else {
                mergePiece();
                checkLines();
                spawnPiece();
            }
            drawBoard();
        }

        function rotatePiece() {
            const originalShape = currentPiece.shape;
            const rotated = [];
            const piece = currentPiece.shape;
            
            for (let i = 0; i < piece[0].length; i++) {
                rotated[i] = [];
                for (let j = 0; j < piece.length; j++) {
                    rotated[i][j] = piece[piece.length - 1 - j][i];
                }
            }
            
            currentPiece.shape = rotated;
            if (collide()) {
                currentPiece.shape = originalShape;
            }
            drawBoard();
        }

        function hardDrop() {
            while (!collide(currentX, currentY + 1)) {
                currentY++;
                score += 2;
            }
            mergePiece();
            checkLines();
            spawnPiece();
            updateDisplay();
            drawBoard();
        }

        function pauseGame() {
            if (gameActive && !gameOver) {
                gamePaused = !gamePaused;
                if (gamePaused) {
                    cancelAnimationFrame(animationId);
                    showNotification('‚è∏ –ü–∞—É–∑–∞');
                } else {
                    lastTime = 0;
                    animationId = requestAnimationFrame(gameLoop);
                    showNotification('‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º');
                }
            }
        }

        function restartGame() {
            if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.')) {
                initGame();
            }
        }

        async function saveGameScore() {
            if (!gameActive || gameOver) return;
            
            showNotification('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É...');
            
            const result = await sendGameDataToBot({
                action: 'game_save',
                score: score,
                level: level,
                lines: lines,
                gameOver: false
            });
            
            if (result.database.success) {
                showNotification('‚úÖ –ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î!');
            } else if (result.telegram.success) {
                showNotification('‚úÖ –ò–≥—Ä–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –±–æ—Ç–∞!');
            } else {
                showNotification('‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ');
            }
        }

        function endGame() {
            if (!gameActive) return;
            
            gameActive = false;
            cancelAnimationFrame(animationId);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            sendGameDataToBot({
                action: 'game_over',
                score: score,
                level: level,
                lines: lines,
                gameOver: true,
                finalScore: score
            });
            
            setTimeout(() => {
                showNotification(`üéØ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –°—á–µ—Ç: ${score}`);
                backToMenu();
                loadUserStats();
            }, 1500);
        }

        function updateDisplay() {
            document.getElementById('score').textContent = score;
            document.getElementById('level').textContent = level;
            document.getElementById('lines').textContent = lines;
            document.getElementById('current-score').textContent = score;
            document.getElementById('current-level').textContent = level;
        }

        function drawBoard() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –§–æ–Ω
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    if (board[y][x]) {
                        drawBlock(x, y, board[y][x], false);
                    }
                }
            }
            
            // –¢–µ–∫—É—â–∞—è —Ñ–∏–≥—É—Ä–∞
            if (currentPiece) {
                for (let y = 0; y < currentPiece.shape.length; y++) {
                    for (let x = 0; x < currentPiece.shape[y].length; x++) {
                        if (currentPiece.shape[y][x]) {
                            drawBlock(currentX + x, currentY + y, currentPiece.color, true);
                        }
                    }
                }
            }
            
            // –°–µ—Ç–∫–∞
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            
            for (let x = 0; x <= COLS; x++) {
                ctx.beginPath();
                ctx.moveTo(x * BLOCK_SIZE, 0);
                ctx.lineTo(x * BLOCK_SIZE, ROWS * BLOCK_SIZE);
                ctx.stroke();
            }
            
            for (let y = 0; y <= ROWS; y++) {
                ctx.beginPath();
                ctx.moveTo(0, y * BLOCK_SIZE);
                ctx.lineTo(COLS * BLOCK_SIZE, y * BLOCK_SIZE);
                ctx.stroke();
            }
        }

        function drawBlock(x, y, color, isCurrent) {
            const blockX = x * BLOCK_SIZE;
            const blockY = y * BLOCK_SIZE;
            
            ctx.fillStyle = color;
            ctx.fillRect(blockX, blockY, BLOCK_SIZE, BLOCK_SIZE);
            
            // –ì—Ä–∞–Ω–∏—Ü–∞
            ctx.strokeStyle = isCurrent ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.5)';
            ctx.lineWidth = isCurrent ? 3 : 1;
            ctx.strokeRect(blockX, blockY, BLOCK_SIZE, BLOCK_SIZE);
            
            // –°–≤–µ—á–µ–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ñ–∏–≥—É—Ä—ã
            if (isCurrent) {
                ctx.shadowColor = color;
                ctx.shadowBlur = 15;
                ctx.fillRect(blockX, blockY, BLOCK_SIZE, BLOCK_SIZE);
                ctx.shadowBlur = 0;
            }
        }

        function gameLoop(time) {
            if (gameOver || gamePaused) return;
            
            const delta = time - lastTime;
            lastTime = time;
            
            dropCounter += delta;
            if (dropCounter > dropInterval) {
                moveDown();
                dropCounter = 0;
            }
            
            drawBoard();
            animationId = requestAnimationFrame(gameLoop);
        }

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ====================
        function showScreenById(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function startGame() {
            if (userCity === '–ù–µ —É–∫–∞–∑–∞–Ω') {
                showCityInput();
                return;
            }
            initGame();
        }

        function showCityInput() {
            const newCity = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ:', userCity);
            if (newCity && newCity.trim() && newCity !== userCity) {
                userCity = newCity.trim();
                localStorage.setItem('tetris_city', userCity);
                updateUserUI();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –≤ –ë–î
                updateUserCityInDB();
                
                showNotification(`üìç –ì–æ—Ä–æ–¥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${userCity}`);
            }
        }

        async function updateUserCityInDB() {
            try {
                const response = await fetch('/api/update-user-city', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        username: username,
                        city: userCity
                    })
                });
                
                if (response.ok) {
                    addDebug('‚úÖ –ì–æ—Ä–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –ë–î');
                }
            } catch (error) {
                addDebug('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞:', error.message);
            }
        }

        function backToMenu() {
            if (gameActive && !gamePaused) {
                pauseGame();
            }
            showScreenById('menu-screen');
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function addDebug(message, data = null) {
            const debugLog = document.getElementById('debug-log');
            if (!debugLog) return;
            
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `
                <span class="debug-time">[${time}]</span>
                <span class="debug-message">${message}</span>
            `;
            
            if (data) {
                const dataStr = typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data);
                entry.innerHTML += `<pre style="color: #8b9dc3; margin: 5px 0 0 20px; font-size: 0.75rem;">${dataStr}</pre>`;
            }
            
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log(`[${time}] ${message}`, data || '');
        }

        function showNotification(message, type = 'normal') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
            
            addDebug(`üì¢ ${message}`);
        }

        function saveToLocalStorage(data) {
            try {
                let games = JSON.parse(localStorage.getItem('tetris_games') || '[]');
                games.push({
                    ...data,
                    timestamp: new Date().toISOString(),
                    localSave: true
                });
                
                // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –∏–≥—Ä
                if (games.length > 50) {
                    games = games.slice(-50);
                }
                
                localStorage.setItem('tetris_games', JSON.stringify(games));
                addDebug('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ');
            } catch (error) {
                addDebug('‚ùå –û—à–∏–±–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error.message);
            }
        }

        function loadLocalStats() {
            try {
                const games = JSON.parse(localStorage.getItem('tetris_games') || '[]');
                const userGames = games.filter(g => g.userId === userId);
                
                if (userGames.length > 0) {
                    const bestScore = Math.max(...userGames.map(g => g.score || 0));
                    const bestLevel = Math.max(...userGames.map(g => g.level || 1));
                    const totalLines = userGames.reduce((sum, g) => sum + (g.lines || 0), 0);
                    const avgScore = userGames.reduce((sum, g) => sum + (g.score || 0), 0) / userGames.length;
                    
                    displayUserStats({
                        best_score: bestScore,
                        best_level: bestLevel,
                        total_lines: totalLines,
                        games_played: userGames.length,
                        avg_score: Math.round(avgScore),
                        city: userCity
                    });
                } else {
                    displayDefaultStats();
                }
            } catch (error) {
                addDebug('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error.message);
                displayDefaultStats();
            }
        }

        function displayDefaultStats() {
            const statsGrid = document.getElementById('user-stats');
            if (!statsGrid) return;
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">–õ—É—á—à–∏–π —Å—á–µ—Ç</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å</div>
                    <div class="stat-value">1</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–í—Å–µ–≥–æ –ª–∏–Ω–∏–π</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Å—á–µ—Ç</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ì–æ—Ä–æ–¥</div>
                    <div class="stat-value">${userCity}</div>
                </div>
            `;
        }

        function clearLocalStats() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?')) {
                localStorage.removeItem('tetris_games');
                showNotification('üóëÔ∏è –õ–æ–∫–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–∏—â–µ–Ω–∞');
                loadLocalStats();
            }
        }

        async function testDatabase() {
            showNotification('üîó –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î...');
            
            try {
                const response = await fetch('/api/test-connection');
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î', 'error');
                }
                
                addDebug('üîó –¢–µ—Å—Ç –ë–î:', result);
            } catch (error) {
                showNotification('‚ùå –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                addDebug('‚ùå –¢–µ—Å—Ç –ë–î:', error.message);
            }
        }

        async function testTelegramBot() {
            showNotification('ü§ñ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–≤—è–∑—å —Å –±–æ—Ç–æ–º...');
            
            const result = await sendDataToTelegramBot({
                action: 'test_connection',
                userId: userId,
                username: username,
                timestamp: new Date().toISOString(),
                message: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∏–≥—Ä—ã'
            });
            
            if (result.success) {
                showNotification('‚úÖ –°–≤—è–∑—å —Å –±–æ—Ç–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–æ—Ç–æ–º', 'error');
            }
        }

        function sendStartDataToBot() {
            if (!tg || !tg.sendData) return;
            
            setTimeout(() => {
                sendDataToTelegramBot({
                    action: 'app_start',
                    userId: userId,
                    username: username,
                    city: userCity,
                    platform: tg.platform,
                    timestamp: new Date().toISOString()
                });
            }, 1000);
        }

        // ==================== –ö–õ–ê–í–ò–ê–¢–£–†–ê ====================
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('game-screen').classList.contains('active')) return;
            
            switch(e.key) {
                case 'ArrowLeft': e.preventDefault(); moveLeft(); break;
                case 'ArrowRight': e.preventDefault(); moveRight(); break;
                case 'ArrowDown': e.preventDefault(); moveDown(); break;
                case 'ArrowUp': e.preventDefault(); rotatePiece(); break;
                case ' ': e.preventDefault(); hardDrop(); break;
                case 'p': case 'P': e.preventDefault(); pauseGame(); break;
                case 'r': case 'R': e.preventDefault(); restartGame(); break;
                case 'Escape': e.preventDefault(); backToMenu(); break;
                case 's': case 'S': e.preventDefault(); saveGameScore(); break;
            }
        });

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        function init() {
            addDebug('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ä–æ–¥ –∏–∑ localStorage
            const savedCity = localStorage.getItem('tetris_city');
            if (savedCity) {
                userCity = savedCity;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
            initTelegram();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º canvas
            canvas.width = COLS * BLOCK_SIZE;
            canvas.height = ROWS * BLOCK_SIZE;
            drawBoard();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            setTimeout(() => loadUserStats(), 500);
            
            addDebug('‚úÖ –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É');
            showNotification('üéÆ –¢–µ—Ç—Ä–∏—Å –∑–∞–≥—Ä—É–∂–µ–Ω!');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', init);
    </script>
</body>
</html>
